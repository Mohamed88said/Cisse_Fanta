{% extends "base.html" %}
{% block content %}
<div class="header-container">
    <h1>üì∏ Notre Galerie Photo</h1>
    <p>Nos souvenirs pr√©cieux immortalis√©s</p>
</div>

<div class="navigation-links">
    <a href="{{ url_for('index') }}" class="btn btn-secondary">üíå Retour aux messages</a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="flash-messages">
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="upload-section">
    <h2>‚ûï Ajouter une photo</h2>
    <form method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data" class="upload-form">
        <div class="form-group">
            <input type="file" name="file" accept="image/*" required class="file-input">
            <div class="file-info">
                <small>Formats accept√©s: PNG, JPG, JPEG, GIF, WEBP (max 16MB)</small>
            </div>
        </div>
        <div class="form-group">
            <input type="text" name="legende" placeholder="L√©gende de la photo..." class="form-input" maxlength="200">
        </div>
        <button type="submit" class="btn btn-primary">üì∏ Uploader la photo</button>
    </form>
</div>

<div class="gallery-container">
    {% if photos %}
        <div class="gallery-grid">
            {% for photo in photos %}
                <div class="gallery-item">
                    <img src="{{ photo.cloudinary_url }}" 
                         alt="{{ photo.legende }}" 
                         loading="lazy"
                         onclick="openModal('{{ photo.cloudinary_url }}', '{{ photo.legende }}', '{{ photo.auteur }}', '{{ photo.date.strftime('%d/%m/%Y') }}')">
                    <div class="gallery-caption">
                        <h3>{{ photo.legende or 'Sans l√©gende' }}</h3>
                        <div class="photo-meta">
                            <div class="photo-author">üì∑ {{ photo.auteur }}</div>
                            <div class="photo-date">üìÖ {{ photo.date.strftime('%d/%m/%Y') }}</div>
                            {% if photo.file_size %}
                                <div class="photo-size">üìè {{ "%.1f"|format(photo.file_size / 1024 / 1024) }} MB</div>
                            {% endif %}
                        </div>
                        <div class="photo-actions">
                            <button onclick="likePhoto({{ photo.id }}); event.stopPropagation();" class="like-btn">
                                ‚ù§Ô∏è <span id="photo-likes-{{ photo.id }}">{{ photo.likes or 0 }}</span>
                            </button>
                            {% if photo.auteur == user %}
                                <a href="{{ url_for('supprimer_photo', photo_id=photo.id) }}" 
                                   class="btn btn-small btn-logout" 
                                   onclick="event.stopPropagation(); return confirm('Supprimer cette photo?')">
                                    üóëÔ∏è
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if pagination.pages > 1 %}
            <div class="pagination">
                {% if pagination.has_prev %}
                    <a href="{{ url_for('galerie', page=pagination.prev_num) }}" class="btn btn-secondary">‚Üê Pr√©c√©dent</a>
                {% endif %}
                
                {% for page_num in pagination.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != pagination.page %}
                            <a href="{{ url_for('galerie', page=page_num) }}" class="btn btn-outline">{{ page_num }}</a>
                        {% else %}
                            <span class="btn btn-primary current-page">{{ page_num }}</span>
                        {% endif %}
                    {% else %}
                        <span class="pagination-ellipsis">‚Ä¶</span>
                    {% endif %}
                {% endfor %}
                
                {% if pagination.has_next %}
                    <a href="{{ url_for('galerie', page=pagination.next_num) }}" class="btn btn-secondary">Suivant ‚Üí</a>
                {% endif %}
            </div>
        {% endif %}
    {% else %}
        <div class="no-messages">
            <p>üì∑ Aucune photo pour le moment... Ajoute la premi√®re!</p>
        </div>
    {% endif %}
</div>

<!-- Modal pour afficher les photos en grand -->
<div id="photoModal" class="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close" onclick="closeModal()">&times;</span>
        <img id="modalImage" src="" alt="">
        <div class="modal-info">
            <h3 id="modalCaption"></h3>
            <p id="modalMeta"></p>
        </div>
    </div>
</div>

<script>
// Fonction pour liker une photo
function likePhoto(photoId) {
    fetch(`/like_photo/${photoId}`, {
        method: 'GET',
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById(`photo-likes-${photoId}`).textContent = data.likes;
    })
    .catch(error => {
        console.error('Erreur:', error);
    });
}

// Modal pour les photos
function openModal(src, caption, author, date) {
    document.getElementById('photoModal').style.display = 'block';
    document.getElementById('modalImage').src = src;
    document.getElementById('modalCaption').textContent = caption || 'Sans l√©gende';
    document.getElementById('modalMeta').textContent = `Par ${author} le ${date}`;
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    document.getElementById('photoModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Fermer le modal avec Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});
</script>
{% endblock %}